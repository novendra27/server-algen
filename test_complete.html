<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GA KKM Optimization - Complete Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .panel {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .panel h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        textarea {
            font-family: 'Courier New', monospace;
            min-height: 200px;
            resize: vertical;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s;
            margin-right: 10px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
        }
        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #bdc3c7 0%, #2c3e50 100%);
        }
        #response, #wsMessages {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-queued { background: #2196F3; color: white; }
        .status-processing { background: #FF9800; color: white; }
        .status-completed { background: #4CAF50; color: white; }
        .status-failed { background: #F44336; color: white; }
        .status-disconnected { background: #9E9E9E; color: white; }
        .status-connected { background: #4CAF50; color: white; }
        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #2196F3;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .success-box {
            background: #e8f5e9;
            border-left-color: #4CAF50;
        }
        .error-box {
            background: #ffebee;
            border-left-color: #F44336;
        }
        .json-key { color: #9cdcfe; }
        .json-string { color: #ce9178; }
        .json-number { color: #b5cea8; }
        .json-boolean { color: #569cd6; }
        .sample-data {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .ws-status {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .message-time {
            color: #888;
            font-size: 11px;
        }
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        @media (max-width: 1200px) {
            .panels {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß¨ GA KKM Optimization API - Complete Tester</h1>

        <div class="panels">
            <!-- LEFT PANEL: POST REQUEST -->
            <div class="panel">
                <h2>üì§ Step 1: POST /api/optimize</h2>
                
                <div class="info-box">
                    <strong>üí° Cara Pakai:</strong><br>
                    1. Sesuaikan parameter GA di bawah<br>
                    2. Pilih sample data atau paste JSON custom<br>
                    3. Klik "Send Request"<br>
                    4. Copy job_id yang muncul di response
                </div>

                <div class="form-group">
                    <label>API URL:</label>
                    <input type="text" id="apiUrl" value="http://localhost:8000/api/optimize" readonly>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label>Population Size:</label>
                        <input type="number" id="popsize" value="50" min="1">
                    </div>
                    <div class="form-group">
                        <label>Generation:</label>
                        <input type="number" id="maxGen" value="100" min="1">
                    </div>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label>Crossover Rate (CR):</label>
                        <input type="number" id="cr" value="0.6" min="0" max="1" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Mutation Rate (MR):</label>
                        <input type="number" id="mr" value="0.4" min="0" max="1" step="0.1">
                    </div>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label>Kriteria Penghentian:</label>
                        <input type="number" id="targetFitness" value="0.95" min="0" max="1" step="0.05">
                    </div>
                    <div class="form-group">
                        <label>Jumlah Kelompok:</label>
                        <input type="number" id="jumlahKelompok" value="10" min="1">
                    </div>
                </div>

                <div class="form-group">
                    <label>Sample Data:</label>
                    <select id="sampleData" onchange="loadSampleData()">
                        <option value="">-- Pilih Sample Data --</option>
                        <option value="small">Small (100 mahasiswa, 10 kelompok)</option>
                        <option value="medium">Medium (500 mahasiswa, 50 kelompok)</option>
                        <option value="custom">Custom (edit manual)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Data Mahasiswa (JSON Array):</label>
                    <textarea id="dataJson" placeholder='[{"ID": 1, "Jenis_Kelamin": "LK", "Jurusan": "TI", "HTQ": "Ya"}, ...]'></textarea>
                    <div class="sample-data">Format: [{"ID": int, "Jenis_Kelamin": "LK/PR", "Jurusan": string, "HTQ": "Ya/Tidak"}]</div>
                </div>

                <div>
                    <button onclick="sendOptimizationRequest()">üì§ Send Request</button>
                    <button onclick="clearResponse()" class="btn-secondary">üóëÔ∏è Clear</button>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label>Response:</label>
                    <div id="response">Waiting for request...</div>
                </div>
            </div>

            <!-- RIGHT PANEL: WEBSOCKET -->
            <div class="panel">
                <h2>üîå Step 2: WebSocket Connection</h2>

                <div class="info-box">
                    <strong>üí° Cara Pakai:</strong><br>
                    1. Paste job_id dari response kiri<br>
                    2. Klik "Connect WebSocket"<br>
                    3. Tunggu hasil optimasi real-time!
                </div>

                <div class="ws-status status-disconnected" id="wsStatus">
                    ‚ö´ Disconnected
                </div>

                <div class="form-group">
                    <label>Job ID:</label>
                    <input type="text" id="jobId" placeholder="Paste job_id dari response">
                    <div class="sample-data">Otomatis terisi setelah POST request berhasil</div>
                </div>

                <div class="form-group">
                    <label>WebSocket URL:</label>
                    <input type="text" id="wsUrl" value="ws://localhost:8000/ws/" readonly>
                </div>

                <div>
                    <button id="connectBtn" onclick="connectWebSocket()" class="btn-success">
                        üîå Connect WebSocket
                    </button>
                    <button id="disconnectBtn" onclick="disconnectWebSocket()" disabled class="btn-danger">
                        ‚ùå Disconnect
                    </button>
                    <button onclick="clearMessages()" class="btn-secondary">üóëÔ∏è Clear</button>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label>WebSocket Messages:</label>
                    <div id="wsMessages">Waiting for connection...</div>
                </div>
            </div>
        </div>

        <!-- BOTTOM PANEL: RESULTS -->
        <div class="panel full-width">
            <h2>üìä Optimization Results</h2>
            <div id="results">
                <div style="text-align: center; color: #999; padding: 40px;">
                    Hasil optimasi akan muncul di sini setelah proses selesai...
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;

        // ===== SAMPLE DATA GENERATOR =====
        function generateSampleData(count, kelompok) {
            const jurusans = ['Teknik Informatika', 'Sistem Informasi', 'Teknik Elektro', 'Manajemen', 'Akuntansi', 'Hukum'];
            const data = [];
            
            for (let i = 1; i <= count; i++) {
                data.push({
                    ID: i,
                    Jenis_Kelamin: Math.random() > 0.5 ? 'LK' : 'PR',
                    Jurusan: jurusans[Math.floor(Math.random() * jurusans.length)],
                    HTQ: Math.random() > 0.7 ? 'Ya' : 'Tidak'
                });
            }
            
            return data;
        }

        function loadSampleData() {
            const select = document.getElementById('sampleData');
            const textarea = document.getElementById('dataJson');
            const kelompokInput = document.getElementById('jumlahKelompok');
            
            if (select.value === 'small') {
                const data = generateSampleData(100, 10);
                textarea.value = JSON.stringify(data, null, 2);
                kelompokInput.value = 10;
            } else if (select.value === 'medium') {
                const data = generateSampleData(500, 50);
                textarea.value = JSON.stringify(data, null, 2);
                kelompokInput.value = 50;
            } else if (select.value === 'custom') {
                textarea.value = '';
                textarea.focus();
            }
        }

        // ===== POST REQUEST =====
        async function sendOptimizationRequest() {
            const responseDiv = document.getElementById('response');
            responseDiv.textContent = '‚è≥ Sending request...';

            try {
                // Build request body
                const requestBody = {
                    parameters: {
                        popsize: parseInt(document.getElementById('popsize').value),
                        generation: parseInt(document.getElementById('maxGen').value),
                        cr: parseFloat(document.getElementById('cr').value),
                        mr: parseFloat(document.getElementById('mr').value),
                        kriteria_penghentian: parseFloat(document.getElementById('targetFitness').value),
                        jumlah_kelompok: parseInt(document.getElementById('jumlahKelompok').value)
                    },
                    data: JSON.parse(document.getElementById('dataJson').value)
                };

                // Send request
                const response = await fetch(document.getElementById('apiUrl').value, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (response.ok) {
                    // Success
                    responseDiv.innerHTML = `<div style="color: #4CAF50; font-weight: bold;">‚úÖ Success!</div>\n${JSON.stringify(data, null, 2)}`;
                    
                    // Auto-fill job_id
                    if (data.job_id) {
                        document.getElementById('jobId').value = data.job_id;
                        
                        // Show success message
                        const infoBox = document.createElement('div');
                        infoBox.className = 'info-box success-box';
                        infoBox.innerHTML = `<strong>‚úÖ Job Created!</strong><br>Job ID: <code>${data.job_id}</code><br>Sekarang klik "Connect WebSocket" di panel kanan!`;
                        
                        const wsPanel = document.querySelector('.panel:nth-child(2)');
                        const existingInfo = wsPanel.querySelector('.info-box.success-box');
                        if (existingInfo) existingInfo.remove();
                        wsPanel.insertBefore(infoBox, wsPanel.children[2]);
                    }
                } else {
                    // Error
                    responseDiv.innerHTML = `<div style="color: #F44336; font-weight: bold;">‚ùå Error ${response.status}</div>\n${JSON.stringify(data, null, 2)}`;
                }

            } catch (error) {
                responseDiv.innerHTML = `<div style="color: #F44336; font-weight: bold;">‚ùå Error!</div>\n${error.message}`;
            }
        }

        // ===== WEBSOCKET =====
        function connectWebSocket() {
            const jobId = document.getElementById('jobId').value.trim();
            const wsUrl = document.getElementById('wsUrl').value.trim();
            const messagesDiv = document.getElementById('wsMessages');
            const statusDiv = document.getElementById('wsStatus');

            if (!jobId) {
                alert('‚ùå Job ID tidak boleh kosong!\n\nKirim POST request terlebih dahulu untuk mendapatkan job_id.');
                return;
            }

            const fullUrl = `${wsUrl}${jobId}`;
            
            messagesDiv.innerHTML = `<div class="message-time">[${new Date().toLocaleTimeString()}]</div>Connecting to ${fullUrl}...\n\n`;
            statusDiv.className = 'ws-status status-processing';
            statusDiv.innerHTML = 'üü° Connecting...';

            try {
                ws = new WebSocket(fullUrl);

                ws.onopen = function() {
                    statusDiv.className = 'ws-status status-connected';
                    statusDiv.innerHTML = 'üü¢ Connected';
                    messagesDiv.innerHTML += `<div style="color: #4CAF50;">‚úÖ Connected successfully!</div>\n\n`;
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                };

                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    const time = new Date().toLocaleTimeString();
                    
                    messagesDiv.innerHTML += `<div class="message-time">[${time}]</div>`;
                    messagesDiv.innerHTML += `üì® Status: <span class="status status-${data.status}">${data.status.toUpperCase()}</span>\n`;
                    
                    if (data.message) {
                        messagesDiv.innerHTML += `   Message: ${data.message}\n`;
                    }
                    
                    if (data.result) {
                        messagesDiv.innerHTML += `\n<div style="color: #4CAF50; font-weight: bold;">üéâ Optimization Completed!</div>\n`;
                        displayResults(data.result);
                    }
                    
                    if (data.error) {
                        messagesDiv.innerHTML += `\n<div style="color: #F44336;">‚ùå Error: ${data.error}</div>\n`;
                    }
                    
                    messagesDiv.innerHTML += '\n';
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                };

                ws.onerror = function(error) {
                    messagesDiv.innerHTML += `<div style="color: #F44336;">‚ùå WebSocket Error!</div>\n`;
                    statusDiv.className = 'ws-status status-failed';
                    statusDiv.innerHTML = 'üî¥ Error';
                };

                ws.onclose = function(event) {
                    messagesDiv.innerHTML += `<div class="message-time">[${new Date().toLocaleTimeString()}]</div>`;
                    messagesDiv.innerHTML += `üîå Connection closed (Code: ${event.code})\n`;
                    statusDiv.className = 'ws-status status-disconnected';
                    statusDiv.innerHTML = '‚ö´ Disconnected';
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;
                    ws = null;
                };

            } catch (error) {
                messagesDiv.innerHTML += `<div style="color: #F44336;">‚ùå Failed to connect: ${error.message}</div>\n`;
                statusDiv.className = 'ws-status status-failed';
                statusDiv.innerHTML = 'üî¥ Failed';
            }
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
            }
        }

        function clearMessages() {
            document.getElementById('wsMessages').textContent = 'Waiting for connection...';
        }

        function clearResponse() {
            document.getElementById('response').textContent = 'Waiting for request...';
        }

        // ===== DISPLAY RESULTS =====
        function displayResults(result) {
            const resultsDiv = document.getElementById('results');
            const stats = result.statistics;
            const kelompokList = result.kelompok_list;

            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; border-left: 4px solid #2196F3;">
                        <div style="color: #1976d2; font-weight: bold;">Best Fitness</div>
                        <div style="font-size: 24px; font-weight: bold;">${stats.best_fitness}/${stats.max_fitness}</div>
                        <div style="color: #666; font-size: 12px;">${(stats.best_normalized_fitness * 100).toFixed(2)}%</div>
                    </div>
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 5px; border-left: 4px solid #4CAF50;">
                        <div style="color: #2e7d32; font-weight: bold;">Generations</div>
                        <div style="font-size: 24px; font-weight: bold;">${stats.total_generations}</div>
                    </div>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 5px; border-left: 4px solid #FF9800;">
                        <div style="color: #ef6c00; font-weight: bold;">Execution Time</div>
                        <div style="font-size: 24px; font-weight: bold;">${stats.execution_time_seconds}s</div>
                    </div>
                    <div style="background: #f3e5f5; padding: 15px; border-radius: 5px; border-left: 4px solid #9C27B0;">
                        <div style="color: #7b1fa2; font-weight: bold;">Total Kelompok</div>
                        <div style="font-size: 24px; font-weight: bold;">${kelompokList.length}</div>
                    </div>
                </div>

                <h3>üìã Kelompok Details (First 10)</h3>
                <div style="max-height: 300px; overflow-y: auto; background: #f5f5f5; padding: 15px; border-radius: 5px;">
            `;

            kelompokList.slice(0, 10).forEach((kelompok, index) => {
                const detail = result.kelompok_details[index];
                const constraints = detail.constraints;
                
                html += `
                    <div style="background: white; padding: 10px; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid ${detail.score === 4 ? '#4CAF50' : '#FF9800'};">
                        <strong>Kelompok ${index + 1}</strong> 
                        <span style="float: right;">Score: ${detail.score}/4 ${detail.score === 4 ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                        <br>
                        <span style="font-size: 12px; color: #666;">
                            Anggota: ${kelompok.length} | 
                            C1: ${constraints.C1_HTQ ? '‚úÖ' : '‚ùå'} | 
                            C2: ${constraints.C2_Heterogenitas_Jurusan ? '‚úÖ' : '‚ùå'} | 
                            C3: ${constraints.C3_Proporsi_Gender ? '‚úÖ' : '‚ùå'} | 
                            C4: ${constraints.C4_Jumlah_Anggota ? '‚úÖ' : '‚ùå'}
                        </span>
                    </div>
                `;
            });

            html += `</div>`;

            resultsDiv.innerHTML = html;
        }

        // Auto-load small sample on page load
        window.onload = function() {
            document.getElementById('sampleData').value = 'small';
            loadSampleData();
        };
    </script>
</body>
</html>
